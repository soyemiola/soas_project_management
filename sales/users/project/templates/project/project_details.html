{% extends 'layout.html' %}
{% block content %}
<div class="content-wrapper">
  <!-- Content -->
  <div class="container-xxl flex-grow-1 container-p-y">
    <h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">Project /</span> {{ project.data.project_name }}</h4>

    <div class="card">
      <div class="card-body">
        <div class="row">
          <!-- Client info -->
          <div class="col-md-3" id="info">
            <div class="card mb-3">
              <div class="row g-0">
                <div class="col-md-4">
                  <img class="card-img card-img-left" src="{{ url_for('static', filename='assets/img/elements/12.jpg') }}" alt="Card image">
                </div>
                <div class="col-md-8">
                  <div class="card-body">
                    <h5 class="card-title mb-0">{{ project.data.client_name }}</h5>
                    <small class="text-muted">{{ project.data.industry }}</small><br>
                    <small class="text-muted">{{ project.data.address }}</small> <br>
                    <span class="badge bg-label-primary">{{ project.data.project_type }} project</span>
                  </div>
                </div>
              </div>
              <div class="row g-0">
                <div class="col-md-12">
                  <div class="divider divider-info">
                    <div class="divider-text">Contact person's</div>
                  </div>
                  {% if details %}
                    {% for cp in details.contacts %}
                      <a class="dropdown-item p-1 m-1" href="#">
                        <div class="d-flex">
                          <div class="flex-shrink-0 me-3">
                            <div class="avatar avatar-online">
                              <img src="{{ url_for('static', filename='assets/img/avatars/1.png') }}" alt="" class="w-px-40 h-auto rounded-circle">
                            </div>
                          </div>
                          <div class="flex-grow-1">
                            <span class="fw-semibold d-block">{{ cp[0].name }}</span>
                            <small class="text-muted">{{ cp[0].position }} </small><br>
                            <small class="text-muted">{{ cp[0].email | truncate(30)}} </small>
                          </div>
                        </div>
                      </a>
                    {% endfor %}
                  {% endif %}
                  <div class="divider divider-primary">
                    <div class="divider-text">Project Team</div>
                  </div>
                  <div class="card overflow-hidden mb-4" style="height: 300px">
                    <div class="card-body ps ps--active-y p-1" id="vertical-example2">
                    {% if details %}
                    {% for cp in details.team_members %}
                      <a class="dropdown-item p-1 m-1" href="{{ url_for('member.member_profile', userid=cp[0].id) }}">
                        <div class="d-flex">
                          <div class="flex-shrink-0 me-3">
                            <div class="avatar avatar-online">
                              <img src="{{ url_for('static', filename='assets/img/avatars/'+cp[0].img) }}" alt="img" class="w-px-40 h-auto rounded-circle">
                            </div>
                          </div>
                          <div class="flex-grow-1">
                            <span class="fw-semibold d-block">{{ cp[0].fullname }}</span>
                            <small class="text-muted">{{ cp[0].department }} </small><br>
                            <small class="text-muted">{{ cp[0].email | truncate(30) }} </small>
                          </div>
                        </div>
                      </a>
                      <hr>
                    {% endfor %}
                  {% endif %}
                    <div class="ps__rail-x" style="left: 0px; bottom: 0px;">
                      <div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                    </div>
                    <div class="ps__rail-y" style="top: 0px; height: 232px; right: 0px;">
                      <div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 35px;"></div>
                    </div>
                    </div>                    
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- // end client info -->

          <!-- Details -->
          <div class="col-md-9" id="details">
            <div class="card overflow-hidden mb-4" style="height: 700px;">
              <div class="card-header">
                <h5 class="">
                  Project progress 
                  <a href="{{ url_for('project.project_list') }}" class="btn btn-primary btn-sm" style="float: right;"><i class="bx bx-arrow-back"></i> Back to list </a>
                </h5>
                <div class="progress mt-3 mb-3">
                  {% if project.data.status | lower == 'pending' %}
                  <div class="progress-bar bg-primary progress-bar-striped shadow-none" role="progressbar" style="width: 10%" >{{ project.data.status }}</div>
                  {% elif project.data.status | lower == 'in-progress' %}
                  <div class="progress-bar bg-primary progress-bar-striped shadow-none" role="progressbar" style="width: 25%" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100">pending</div>
                  <div class="progress-bar bg-info progress-bar-striped shadow-none" role="progressbar" style="width: 25%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100">{{ project.data.status }}</div>
                  {% elif project.data.status | lower == 'completed' %}
                  <div class="progress-bar bg-primary progress-bar-striped shadow-none" role="progressbar" style="width: 30%" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100">pending</div>
                  <div class="progress-bar bg-info progress-bar-striped shadow-none" role="progressbar" style="width: 30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100">in-progress</div>
                  <div class="progress-bar bg-success progress-bar-striped shadow-none" role="progressbar" style="width: 40%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">{{ project.data.status }}</div>
                  {% elif project.data.status | lower == 'terminated' %}
                  <div class="progress-bar bg-danger progress-bar-striped shadow-none" role="progressbar" style="width: 100%">{{ project.data.status }}</div>
                  {% endif %}
                </div>
                {% if project.data.status | lower != 'terminated' and project.data.status | lower != 'completed'  %}
                <button type="button" class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addprojectelement"><i class="bx bx-plus"></i> Add item</button>
                {% endif %}
                <button type="button" class="btn btn-primary btn-sm mt-2" onclick="prj_status()"><i class="bx bx-check-square"></i> Update status</button>
                
                <div class="prj_status mt-2" id="prj_status" style="display: none">
                  <div class="divider divider-primary">
                    <div class="divider-text">Project Status</div>
                  </div>
                  <form class="form-inline" id="p_status" method="post">
                    <div class="row">
                      <div class="col-xs-12 col-md-4">
                        <div class="form-group mb-2">
                          <label>Select status:</label>
                          <select class="form-select form-control-sm" name="status">
                            {% if project.data.status | lower == 'pending' %}
                              {% set pn = 'selected' %}
                            {% elif project.data.status | lower == 'in-progress' %}
                              {% set ip = 'selected' %}
                            {% elif project.data.status | lower == 'completed' %}
                              {% set cm = 'selected' %}
                            {% elif project.data.status | lower == 'terminated' %}
                              {% set tm = 'selected' %}
                            {% endif %}
                            <option value="pending" {{ pn }}>Pending</option>
                            <option value="in-progress" {{ ip }}>In-progress</option>
                            <option value="completed" {{ cm }}>Completed</option>
                            <option value="terminted" {{ tm }}>Terminated</option>
                          </select>
                        </div>
                        <div class="form-group">
                          <input type="submit" name="submit" class="btn btn-primary btn-sm" value="Update">
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
              </div>

              <div class="card-body ps ps--active-y" id="vertical-example">
                <div class="divider divider-primary">
                  <div class="divider-text">Project report</div>
                </div>

                {% if uitems %}
                  {% for i in range(uitems.data['items'] | length ) %}
                    {% set cnt = loop.index - 1 %}
                  
                  {% set item_comments = uitems.data['items'][cnt]['id'] | project_comment_list %}
                
                <div class="card mb-2">
                  <div class="card-body">
                    <h5 class="card-title">{{uitems.data['items'][cnt]['subject']}}</h5>
                    <p class="card-text">
                      {{uitems.data['items'][cnt]['description']}}
                    </p>
                    <p class="card-text">
                    <small class="text-muted">
                      {% set user_prof = uitems.data['items'][cnt]['post_by'] | get_user_profile %}

                      Created by: 
                      {% if not user_prof %}
                        <span><i>error fetching record!</i></span>
                      {% else %}
                        {{ user_prof.data.fullname }}
                      {% endif %}
                      
                      | post date: {{ uitems.data['items'][cnt]['post_date_time'] | convert_date_time }}
                      
                    </small> 
                    <br>

                    {% set user_comment = uitems.data['items'][cnt]['id'] | user_comment_img %}

                    {% if user_comment %}
                    <ul class="list-unstyled users-list m-0 avatar-group d-flex align-items-center">
                      {% for cm in user_comment %}
                      <li data-bs-toggle="tooltip" data-popup="tooltip-custom" data-bs-placement="top" class="avatar avatar-xs pull-up" title="" data-bs-original-title="{{ cm.name }}">
                        <img src=" {{ url_for('static', filename='assets/img/avatars/'+cm.img) }}" alt="user avatar" class="rounded-circle">
                      </li>
                      {% endfor %}
                    </ul>
                    {% endif %}
                    <small class="text-muted">Comment: <span>{{ item_comments.data | length }}</span></small> <br>
                    
                    <!-- comment last updated time -->
                    {% if item_comments and item_comments.data | length > 0 %}
                    
                      {% set last_comment_time = item_comments.data[0]['postdatetime'] | last_comment_time %}
                      <small class="text-muted">Last updated {{ last_comment_time }} ago</small>
                    {% endif %}
                    <!-- // end last updated time -->

                    <p class="mt-2">
                      <small class="badge bg-label-primary mr-2 collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vw_{{ loop.index }}" aria-expanded="false" aria-controls="vw_{{ loop.index }}" onclick="close_comment('cm_{{ loop.index }}')">view</small>
                      <small class="badge bg-label-primary mr-2 collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cm_{{ loop.index }}" aria-expanded="false" aria-controls="cm_{{ loop.index }}" onclick="close_view('vw_{{ loop.index }}')">add comment</small>
                    </p>

                    <!-- view details -->
                    <div class="collapse" id="vw_{{ loop.index }}">
                      <div class="d-grid d-sm-flex p-1 border">
                        <div class="nav-align-top mb-4" style="width: 100% !important">
                          <ul class="nav nav-pills mb-3" role="tablist">
                            <li class="nav-item">
                              <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab" data-bs-target="#navs-pills-top-pod_{{loop.index}}" aria-controls="navs-pills-top-pod_{{loop.index}}" aria-selected="true">
                              Note
                              </button>
                            </li>
                            <li class="nav-item">
                              <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#navs-pills-top-actn_{{loop.index}}" aria-controls="navs-pills-top-actn_{{loop.index}}" aria-selected="false">
                              Actionable
                              </button>
                            </li>
                            <li class="nav-item">
                              <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" data-bs-target="#navs-pills-top-dvrb_{{loop.index}}" aria-controls="navs-pills-top-dvrb_{{loop.index}}" aria-selected="false">
                              Deliverables
                              </button>
                            </li>
                          </ul>
                          <div class="tab-content">
                            <!-- Item note -->
                            <div class="tab-pane fade active show" id="navs-pills-top-pod_{{loop.index}}" role="tabpanel">
                              <p id="note_id_{{loop.index}}" data-minutes="" data-details_id="{{loop.index}}">
                                {{uitems.data['items'][cnt]['note']}}
                              </p>
                            </div>
                            <!-- end note -->

                            <!-- Actionables -->
                            <div class="tab-pane fade" id="navs-pills-top-actn_{{loop.index}}" role="tabpanel">
                              <div class="list-group">
                                {% if uitems.data['actionables'] | length > 0 %}
                                  {% for x in uitems.data['actionables'] %}
                                    {% if x.project_item_id == uitems.data['items'][cnt]['id'] %}
                                      <label class="list-group-item">
                                        {% set user_actionable = x.user_id | get_user_profile %}

                                        <img src=" {{ url_for('static', filename='assets/img/avatars/5.png') }}" alt="Avatar" class="rounded-circle" height="25px" data-bs-toggle="tooltip" data-bs-offset="0,4" data-bs-placement="top" data-bs-html="true" title="" data-bs-original-title="{{ user_actionable.data.fullname }}">
                                        {% if x.status | lower != 'done' %}
                                        <input class="form-check-input me-1" type="checkbox" disabled>
                                        {% else %}
                                        <input class="form-check-input me-1" type="checkbox" checked disabled>
                                        {% endif %}

                                        {{ x.task }}

                                        <span style="float: right;">
                                          {% if x.status | lower == 'completed' %}
                                            {% set color = 'success' %}
                                            {% set label = x.status %}
                                          {% elif x.status | lower == 'in-progress' %}
                                            {% set color = 'primary' %}
                                            {% set label = x.status %}
                                          {% elif x.status | lower == 'assigned' %}
                                            {% set color = 'secondary' %}
                                            {% set label = x.status %}
                                          {% endif %}
                                          <small  class="badge badge-sm bg-label-{{ color }}">{{ label }}</small>
                                          <i class="bx bx-edit" style="cursor:pointer;" onclick="opentask('{{x.id}}', '{{x.project_item_id}}', '{{ user_actionable.data.fullname }}', '{{ x.task }}')"></i>                                     
                                        </span>

                                      </label>
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                                </div>
                              
                            </div>
                            <!-- end actionables -->

                            <!-- Deliverables -->
                            <div class="tab-pane fade" id="navs-pills-top-dvrb_{{loop.index}}" role="tabpanel">
                              <div class="list-group">
                                {% if uitems.data['deliverables'] | length > 0 %}
                                  {% for x in uitems.data['deliverables'] %}
                                    {% if x.project_item_id == uitems.data['items'][cnt]['id'] %}
                                      {% for dlv in x['items'] %}
                                      <label class="list-group-item">
                                        {{ dlv }}
                                      </label>
                                      {% endfor %}
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}
                                </div>
                            </div>
                            <!-- end deliverables -->
                          </div>
                          <p class="mb-0 p-3 pb-0">
                            <div id="item_details_info_{{ loop.index }}" style="display: none;" data-item_id="{{uitems.data['items'][cnt]['id']}}" data-subject="{{uitems.data['items'][cnt]['subject']}}" data-description="{{uitems.data['items'][cnt]['description']}}" data-note="{{uitems.data['items'][cnt]['note']}}" data-note_file="{{uitems.data['items'][cnt]['note_docx']}}" data-actionables="{{uitems.data['actionables']}}" data-deliverables="{{ uitems.data['deliverables'] }}"></div>
                            
                            <button class="btn btn-outline-primary btn-sm" onclick="edit_minute_item('item_details_info_{{ loop.index }}')">
                              <i class="bx bx-edit"></i> edit
                            </button> 
                          </p>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="delete_report('minutes_id')">
                          <i class="bx bx-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                    <!-- // end details -->

                    <!-- add comment -->
                    <div class="collapse" id="cm_{{ loop.index }}">
                      <div class=" p-3 border">
                        <form id="project_comment" method="post" action="{{ url_for('project.project_item_comment', project_id=project.data.id) }}">
                          <input type="hidden" name="project_item_id" value="{{ uitems.data['items'][cnt]['id'] }}">
                          <div class="form-group">
                            <label for="ControlTextarea1" class="form-label">Comment</label>
                            <textarea class="form-control" name="comment" id="ControlTextarea1" rows="3" required></textarea>
                          </div>
                          <div class="form-group">
                            <button type="submit" form="project_comment" class="btn btn-primary btn-sm mt-2">Add comment</button>
                          </div>
                        </form>
                        {% if item_comments.data | length > 0 %}
                        <div class="divider divider-primary">
                          <div class="divider-text">comment history</div>
                        </div>
                        {% for x in item_comments.data %}
                        <div>
                          <div class="mb-2">
                            <div class="avatar avatar-online">
                              <img src="{{ url_for('static', filename='assets/img/avatars/'+x.img) }}" alt="" class="w-px-40 h-auto rounded-circle">
                            </div>
                          </div>
                          <p>
                            {{ x.comment }}
                              <br>
                              {% set cdate = x.postdatetime | convert_date %}
                              {% if cdate %}
                              <small class="text-muted"> {{ cdate[0]}} | {{ cdate[1]}} 
                                <i class="bx bx-edit" onclick="edit_comment()"></i>
                              </small>
                              {% endif %}
                          </p>
                        </div>
                        {% endfor %}
                        {% endif %}
                      </div>
                    </div>
                    <!-- // end comment -->
                    </p>
                  </div>
                </div>
                  {% endfor %}
                {% endif %}
                <div class="ps__rail-x" style="left: 0px; bottom: 0px;">
                  <div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                </div>
                <div class="ps__rail-y" style="top: 0px; height: 232px; right: 0px;">
                  <div class="ps__thumb-y" tabindex="0" style="top: 0px; height: 35px;"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- // end details -->
        </div>
      </div>
    </div>
    <!--/ Basic Bootstrap Table -->
  </div>
  <!-- / Content -->
  <div class="content-backdrop fade"></div>
</div>
{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='assets/js/extended-ui-perfect-scrollbar.js') }}"></script>
<script type="text/javascript">
  const addTask = (task_id, user) =>{
    id = document.getElementById(user)
    task = document.getElementById(task_id).value;

    info = id.value

    if (task != '' && info != 0){
      info = info.split(',')
      userid = info[0];
      username = info[1];

      close_id = rand()

      item = `<div class="demo-inline-spacing mt-3" id="`+close_id+`">
                <div class="list-group list-group-flush">
                  <a href="javascript:void(0);" class="list-group-item list-group-item-action">
                    `+task+`
                    <small class="badge bg-label-primary" style="float: right;">
                      `+username+` <i class="bx bx-minus p-0" onclick="removeTask(`+close_id+`)"></i>
                    </small>
                  </a>
                <input type="hidden" name="actionables_id" value="`+userid+`">
                <input type="hidden" name="actionables_task" value="`+task+`">
                </div>
              </div>`;
      $('#actionables_users').append(item);
      document.getElementById(task_id).value = '';

    }else{
      $('#actionables').focus();
    }

                  
  }

  const removeTask = (id) =>{
    $('#'+id).remove()
  }

  const addDev = (deliverables) =>{
    dev = document.getElementById(deliverables).value;

    if (dev != ''){
      close_id = rand()

      item = `<div class=" mt-0 pt-0" id="`+close_id+`">
                <div class="list-group list-group-flush pt-0">
                  <a href="javascript:void(0);" class="list-group-item list-group-item-action">
                    `+dev+`
                    <i class="bx bx-minus p-0" style="float: right" onclick="removedev(`+close_id+`)"></i>
                  </a>
                </div>
                <input type="hidden" name="deliverables" value="`+dev+`">
                </div>
              </div>`;
      
      $('#deliverables_opt').append(item);
      document.getElementById(deliverables).value = '';

    }else{
      $('#deliverable').focus();
    }
  }

  const removedev = (id) =>{
    $('#'+id).remove()
  }

  const close_comment = (id)=>{
    comment = document.getElementById(id)
    if (comment.classList.contains('show')) {
      comment.classList.remove('show')
    }
  }

  const close_view = (id)=>{
    view = document.getElementById(id)
    if (view.classList.contains('show')) {
      view.classList.remove('show')
    }
  }

  const edit_minute_item = (id) =>{
    var id = document.getElementById(id)

    item_id = id.dataset.item_id;
    item_subject = id.dataset.subject;
    item_description = id.dataset.description;
    item_note = id.dataset.note;
    item_note_docx = id.dataset.note_file;
    item_actionables = id.dataset.actionables;
    item_deliverables = id.dataset.deliverables;

    $('#project_item_id').val(item_id);
    $('#item_subject').val(item_subject);
    $('#item_description').val(item_description);
    $('#item_note').val(item_note);
    // $('#item_note_file').val(item_note_docx);


    $('#editmeetingnote').modal('show')
  }

  const delete_report = (id) =>{
    $('#delete_minutes').modal('show')
  }

  const prj_status = ()=>{
    elem = document.getElementById('prj_status')
    if (elem.style.display == 'block') {
      elem.style.display = 'none'
    }else{
      elem.style.display = 'block'
    }
    
  }

    const covertToSeconds = (dateTimeString)=>{
    
    const dateTime = new Date(dateTimeString);
    const currentTime = Math.round(dateTime.getTime() / 1000);
    const elapsed = currentTime - Math.round(Date.now() / 1000);
    return elapsed
  }


  function formatTime(getDate) {
    const string = getDate;
    const dateTime = new Date(string);
    const currentTime = Math.round(dateTime.getTime() / 1000);
    const elapsed = Math.round(Date.now() / 1000) - currentTime;

    if (elapsed >= 60 * 60 * 24) {
      
      const days = Math.floor(elapsed / (60 * 60 * 24));
      const hours = Math.floor((elapsed % (60 * 60 * 24)) / (60 * 60));
      const minutes = Math.floor((elapsed % (60 * 60)) / 60);
      const seconds = elapsed % 60;
      return `${days} day(s), ${hours} hour(s), ${minutes} minute(s), ${seconds} second(s)`;

    } else if (elapsed >= 60 * 60) {
     
     const hours = Math.floor(elapsed / (60 * 60));
      const minutes = Math.floor((elapsed % (60 * 60)) / 60);
      return `${hours} hour(s), ${minutes} minute(s)`;

    } else if (elapsed >= 60) {
      
      const minutes = Math.floor(elapsed / 60);
      return `${minutes} minute(s)`;

    } else {
      
      return `${elapsed} second(s)`;
    }
  }


  const opentask = (id, product_item_id, username, task)=>{
    document.getElementById('assignto').innerHTML = username;
    document.getElementById('actionable_task').innerHTML = task;

    current_user = parseInt('{{ current_user.id }}');
    const task_id = id

    $('#feedback_project_item_id').val(product_item_id);
    $('#feedback_actionable_id').val(id);  

    $.ajax({
      method: 'get',
      url: 'http://localhost:5000/api/v1/actionable/project-task/'+product_item_id+'/details/'+task_id,

      beforeSend: function(){
        $('#feedbackList').empty();
        // add loading icon feedbackList
      },

      success: function(result){
        if(result.data.feedback.length > 0){
          document.getElementById('feedbackhistory').style.display = 'block';

          for (var i = 0; i < result.data.feedback.length; i++) {
            const det = result.data.feedback[i];

            const tm = formatTime(det['postdatetime']);

            img = '<img src={{ url_for("static", filename="assets/img/avatars/avatar_img") }} alt="User" class="rounded" />'
            img = img.replace("avatar_img", det['img'])

            if(det['feedback_user_id'] == current_user){
              item = `
                <li class="d-flex mb-4 pb-1">
                  <div class="d-flex w-100 flex-wrap align-items-center justify-content-between p-2 border border-light">
                    <div class="me-2">
                      <p class="text-muted d-block mb-1">`+det['feedback_comment']+` </p>
                      <small class="mt-1"> `+det['postdatetime']+` | `+tm+` ago</small>
                    </div>
                  </div>
                  <div class="avatar flex-shrink-0 me-3 ml-5" style="margin-left: 20px;">
                     `+ img +`
                  </div>
                </li>
              `;
              
            }else{            
              
              item = `
                <li class="d-flex mb-4 pb-1">
                  <div class="avatar flex-shrink-0 me-3">
                    `+ img +`
                  </div>
                  <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2 p-2 border border-light">
                    <div class="me-2">
                      <p class="text-muted d-block mb-1">`+det['feedback_comment']+` </p>
                      <small class="mt-1"> `+det['postdatetime']+` | `+tm+` ago</small>
                    </div>
                  </div>
                </li>
              `
            }

            $('#feedbackList').append(item);
          }
        }else{
          document.getElementById('feedbackhistory').style.display = 'none';
        }
        
      },

      complete: function(){
        // remove loading icon
      }

    })

    // send forms via ajax request and update list

    $('#taskview').modal('show')
  }

  const addfeedback = ()=>{
    elem = document.getElementById('addfeedbackbx')

    if (elem.style.display == 'none') {
      $('#addfeedbackbx').fadeIn();
    }else{
      $('#addfeedbackbx').fadeOut();
    }
  }

  const rand = function(){
    return Math.floor((Math.random() * 10000) + 1 )
  }

  const submitFeedback = async ()=>{
    const item_id = $('#feedback_project_item_id').val();
    const task_id = $('#feedback_actionable_id').val();
    const feedback = $('#feedback_text').val();
    const postdate = getCurrentDateTime();
    const current_user_id = parseInt('{{ current_user.id }}');
    const current_user_img = '{{ current_user.img }}';
    const tm = formatTime(postdate);

    img = '<img src={{ url_for("static", filename="assets/img/avatars/avatar_img") }} alt="User" class="rounded" />'
    img = img.replace("avatar_img", current_user_img);

    const item = `
                <li class="d-flex mb-4 pb-1">
                  <div class="d-flex w-100 flex-wrap align-items-center justify-content-between p-2 border border-light">
                    <div class="me-2">
                      <p class="text-muted d-block mb-1">`+feedback+` </p>
                      <small class="mt-1"> `+postdate+` | `+tm+` ago</small>
                    </div>
                  </div>
                  <div class="avatar flex-shrink-0 me-3 ml-5" style="margin-left: 20px;">
                     `+ img +`
                  </div>
                </li>
              `;

    if(!feedback || feedback == null){
      document.getElementById('feedback_text').focus();
      return 
    }

    $.ajax({
      method: 'post',
      url: 'http://localhost:5000/api/v1/actionable/project-task/add-feedback',
      data:{project_item_id:item_id, task_id:task_id, userid:current_user_id, feedback:feedback, postdate:postdate},
      contentType: 'application/json',

      beforeSend: function(){
        document.getElementById('feedback_text').disabled = true;
      },

      success: function(res){
        $('#feedbackList').append(item);

        document.getElementById('feedbackhistory').style.display = 'block';
      },

      error: function(e){
        console.log(e);
      },

      complete: function(){
        document.getElementById('feedback_text').disabled = false;
        addfeedback();
      }
    });


  }

  function getCurrentDateTime() {
    const now = new Date();
    
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    const formattedDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;

    return formattedDateTime;
  }





</script>
{% endblock %}

{% block modals %}
<div class="modal fade" id="addprojectelement" data-bs-backdrop="static" tabindex="-1" aria-modal="true" role="dialog">
  <div class="modal-dialog modal-xl">
    <form class="modal-content" method="post" action="{{ url_for('project.project_add_item') }}" enctype="multipart/form-data">
      <input type="hidden" name="project_id" value="{{ project.data.id }}">
      <div class="modal-header">
        <h5 class="modal-title" id="backDropModalTitle">{{ project.data.project_name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-xs-12 col-md-6">
            <div class="row">
              <div class="col mb-3">
                <label for="subjectBackdrop" class="form-label">Subject</label>
                <input type="text" id="subjectBackdrop" name="subject" class="form-control" placeholder="Enter subject">
              </div>
            </div>
            <div class="row">
              <div class="col mb-0">
                <label for="descBackdrop" class="form-label">Description</label>
                <textarea class="form-control" id="descBackdrop" name="description" rows="2" placeholder="Enter description"></textarea>
              </div>
            </div>
            <div class="row">
              <div class="col mb-0">
                <label for="minBackdrop" class="form-label">Note</label>
                <textarea class="form-control" id="minBackdrop" name="note" rows="5" placeholder="Enter note"></textarea>
                <!-- <div class="divider text-start">
                  <div class="divider-text">or upload document</div>
                </div>
                <input class="form-control" type="file" id="formFile" name="note_file">
                <small>Allowed files: .pdf, .docx</small> -->
              </div>
            </div>
          </div>
          <div class="col-xs-12 col-md-6">
            <div class="row g-2">
              <div class="col">
                <label for="actionables" class="form-label">Actionables</label>
                <input type="text" id="actionables" class="form-control">
              </div>
              <div class="col">
                <label for="asnBackdrop" class="form-label">Actionables</label>
                <div class="input-group">
                  <select class="form-select" id="a_team_list">
                    <option selected disabled value="0">--select team member--</option>
                    {% if details %}
                      {% for cp in details.team_members %}
                      <option value="{{ cp[0].id }}, {{ cp[0].fullname }}" data-name="{{ cp[0].fullname }}">{{ cp[0].fullname }}</option>
                      {% endfor %}
                    {% endif %}
                  </select>
                  <label class="input-group-text btn-outline-primary" for="a_team_list" onclick="addTask('actionables','a_team_list')">Add</label>
                </div>
              </div>
            </div>
            <div class="row mt-0 pt-0">
              <div class="col-md-12" id="actionables_users">
                
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col mb-0">
                <label for="dvlBackdrop" class="form-label">Deliverables</label>
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="Deliverables item" aria-label="Deliverables item" aria-describedby="button-addon2" id="deliverable">
                  <button class="btn btn-outline-primary" type="button" id="button-addon2" onclick="addDev('deliverable')">Add item</button>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12" id="deliverables_opt">
                
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
        Close
        </button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="editmeetingnote" data-bs-backdrop="static" tabindex="-1" aria-modal="true" role="dialog">
  <div class="modal-dialog modal-xl">
    <form class="modal-content" method="post" action="{{ url_for('project.project_update_item') }}" enctype="multipart/form-data">
      <input type="hidden" name="project_item_id" id="project_item_id">
      <div class="modal-header">
        <h5 class="modal-title" id="backDropModalTitle">Update project item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-xs-12 col-md-6">
            <div class="row">
              <div class="col mb-3">
                <label for="item_subject" class="form-label">Subject</label>
                <input type="text" name="subject" id="item_subject" class="form-control" placeholder="Enter subject">
              </div>
            </div>
            <div class="row">
              <div class="col mb-0">
                <label for="item_description" class="form-label">Description</label>
                <textarea class="form-control" name="description" id="item_description" rows="2" placeholder="Enter description"></textarea>
              </div>
            </div>
            <div class="row">
              <div class="col mb-0">
                <label for="item_note" class="form-label">Note</label>
                <textarea class="form-control" name="note" id="item_note" rows="5" placeholder="Enter note"></textarea>
                <!-- <div class="divider text-start">
                  <div class="divider-text">or upload document</div>
                </div>
                <input class="form-control" type="file" id="formFile" name="note_file" id="item_note_file">
                <small>Allowed files: .pdf, .docx</small> -->
              </div>
            </div>
          </div>
          <div class="col-xs-12 col-md-6">
            <div class="row g-2">
              <div class="col">
                <label for="actionables" class="form-label">Actionables</label>
                <input type="text" id="actionables" class="form-control">
              </div>
              <div class="col">
                <label for="asnBackdrop" class="form-label">Actionables</label>
                <div class="input-group">
                  <select class="form-select" id="a_team_list">
                    <option selected disabled value="0">--select team member--</option>
                    {% if details %}
                      {% for cp in details.team_members %}
                      <option value="{{ cp[0].id }}, {{ cp[0].fullname }}" data-name="{{ cp[0].fullname }}">{{ cp[0].fullname }}</option>
                      {% endfor %}
                    {% endif %}
                  </select>
                  <label class="input-group-text btn-outline-primary" for="a_team_list" onclick="addTask('actionables','a_team_list')">Add</label>
                </div>
              </div>
            </div>
            <div class="row mt-0 pt-0">
              <div class="col-md-12" id="actionables_users">
                
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col mb-0">
                <label for="dvlBackdrop" class="form-label">Deliverables</label>
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="Deliverables item" aria-label="Deliverables item" aria-describedby="button-addon2" id="deliverable">
                  <button class="btn btn-outline-primary" type="button" id="button-addon2" onclick="addDev('deliverable')">Add item</button>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12" id="deliverables_opt">
                
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
        Close
        </button>
        <button type="submit" class="btn btn-primary">Update</button>
      </div>
    </form>
  </div>
</div>


  <div class="modal fade" id="delete_minutes" data-bs-backdrop="static" tabindex="-1" aria-modal="true" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel1">Delete Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h6> Are you sure to delete record?</h6>
        </div>
        <div class="modal-footer">
          <form method="DELETE" action="#">
            <input type="hidden" name="report_id" id="report_id">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">No</button>
          <button type="submit" class="btn btn-danger">Yes</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="taskview" data-bs-backdrop="static" tabindex="-1" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-md" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="backDropModalTitle">{{ project.data.project_name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-md">
              <div class="divider text-end m-0 p-0">
                <div class="divider-text">Assigned to: <span id="assignto"></span></div>
              </div>
              <small class="text-muted">TASK DETAILS</small>

              <p id="actionable_task"></p>
              <button class="btn btn-outline-primary btn-sm" onclick="addfeedback()"><i class="bx bx-plus"></i> add feedback</button>

              <div id="addfeedbackbx" style="display: none"> 
                <div class="divider divider-light">
                  <div class="divider-text">Add feedback</div>
                </div>
               <form method="post" id="addfeedback">
                  <input type="hidden" value="" id="feedback_project_item_id">
                  <input type="hidden" value="" id="feedback_actionable_id">
                  <div class="form-group">
                    <label>Feedback</label>
                    <textarea class="form-control" name="feedback" id="feedback_text" required></textarea>
                  </div>
                  <div class="form-group mt-1">
                    <button type="button" class="btn btn-primary btn-sm" onclick="submitFeedback()">Submit</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addfeedback()">Close</button>
                  </div>
                </form>
              </div>


              <div class="divider divider-primary" id="feedbackhistory" style="display:none;">
                <div class="divider-text">feedback history</div>
              </div>

              <ul class="p-0 m-0" id="feedbackList">
                
              </ul>

            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Close
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}